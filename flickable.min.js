/*
  Flickable.js - based on flipsnap.js (http://pxgrid.github.com/js-flipsnap/)
  
  Version: 0.1
  Author:  @yuya

  Licensed under the MIT License:
  http://www.opensource.org/licenses/mit-license.php
*/
(function(root,factory){return"function"==typeof define&&"object"===define.amd?define(NS,[],function(){return factory(root,root.document),root[NS]}):factory(root,root.document)})(this,function(global){var NS;return NS="Flickable",global[NS]={}}),function(global,document){var Helper;return Helper=function(){function Helper(){this.div=document.createElement("div"),this.prefixes=["webkit","moz","o","ms"],this.saveProp={}}return Helper.prototype.getPage=function(event,page){return event.changedTouches?event.changedTouches[0][page]:event[page]},Helper.prototype.hasProp=function(props){var prop,_i,_len;if(props instanceof Array){for(_i=0,_len=props.length;_len>_i;_i++)if(prop=props[_i],void 0!==this.div.style[prop])return!0;return!1}if("string"==typeof props)return void 0!==this.div.style[prop]?!0:!1;throw new TypeError("Must be a Array or String")},Helper.prototype.setStyle=function(element,styles){var hasSaveProp,prop,style,_results,_setAttr,_this=this;style=element.style,hasSaveProp=this.saveProp[prop],_setAttr=function(style,prop,val){var prefix,_i,_len,_prop,_ref;if(hasSaveProp)return style[hasSaveProp]=val;if(void 0!==style[prop])return _this.saveProp[prop]=prop,style[prop]=val;for(_ref=_this.prefixes,_i=0,_len=_ref.length;_len>_i;_i++)if(prefix=_ref[_i],_prop=_this.ucFirst(prefix)+_this.ucFirst(prop),void 0!==style[_prop])return _this.saveProp[prop]=_prop,style[_prop]=val,!0;return!1},_results=[];for(prop in styles)_results.push(_setAttr(style,prop,styles[prop]));return _results},Helper.prototype.getCSSVal=function(prop){var prefix,ret,_i,_len,_prop,_ref;if("string"!=typeof prop)throw new TypeError("Must be a String");if(void 0!==this.div.style[prop])return prop;for(_ref=this.prefixes,_i=0,_len=_ref.length;_len>_i;_i++)prefix=_ref[_i],_prop=this.ucFirst(prefix)+this.ucFirst(prop),void 0!==this.div.style[_prop]&&(ret="-"+prefix+"-"+prop);return ret},Helper.prototype.ucFirst=function(str){if("string"!=typeof str)throw new TypeError("Must be a String");return str.charAt(0).toUpperCase()+str.substr(1)},Helper.prototype.triggerEvent=function(element,type,bubbles,cancelable,data){var d,event;if("object"!=typeof element)throw Error("Must be a Element");if(event=document.createEvent("Event"),event.initEvent(type,bubbles,cancelable),data)for(d in data)event[d]=data[d];return element.dispatchEvent(event)},Helper.prototype.checkBrowser=function(){var android,browserName,browserVersion,ios,ua;return ua=global.navigator.userAgent.toLowerCase(),ios=ua.match(/(?:iphone\sos|ip[oa]d.*os)\s([\d_]+)/),android=ua.match(/(android)\s+([\d.]+)/),browserName=ios?"ios":android?"android":"pc",browserVersion=function(){return ios||android?parseFloat((ios||android).pop().split(/\D/).join("."),10):null}(),{name:browserName,version:browserVersion,isLegacy:!!android&&3>browserVersion}},Helper.prototype.checkSupport=function(){var hasTransform,hasTransform3d,hasTransition;return hasTransform3d=this.hasProp(["perspectiveProperty","WebkitPerspective","MozPerspective","msPerspective","OPerspective"]),hasTransform=this.hasProp(["transformProperty","WebkitTransform","MozTransform","msTransform","OTransform"]),hasTransition=this.hasProp(["transitionProperty","WebkitTransitionProperty","MozTransitionProperty","msTransitionProperty","OTransitionProperty"]),{touch:"ontouchstart"in global,eventListener:"addEventListener"in global,transform3d:hasTransform3d,transform:hasTransform,transition:hasTransition,cssAnimation:hasTransform3d||hasTransform&&hasTransition?!0:!1}},Helper.prototype.checkTouchEvents=function(){var hasTouch;return hasTouch=this.checkSupport.touch,{start:hasTouch?"touchstart":"mousedown",move:hasTouch?"touchmove":"mousemove",end:hasTouch?"touchend":"mouseup"}},Helper.prototype.getWidth=function(element){var border,boxSizingVal,css,hasBoxSizing,padding,styleParser,width;if(void 0===element)throw Error("Element Not Found");return css=global.getComputedStyle(element),boxSizingVal=void 0,hasBoxSizing=function(){var prop,properties,_i,_len;for(properties=["-webkit-box-sizing","-moz-box-sizing","-o-box-sizing","-ms-box-sizing","box-sizing"],_i=0,_len=properties.length;_len>_i;_i++)if(prop=properties[_i],void 0!==element.style[prop])return boxSizingVal=element.style[prop],!0;return!1}(),hasBoxSizing&&"content-box"!==boxSizingVal?0===element.scrollWidth?(width=parseFloat(element.style.width.match(/\d+/),10),element.style.boxSizing&&element.style.webkitBoxSizing||(element.style.paddingRight&&(width+=parseFloat(element.style.paddingRight.match(/\d+/),10)),element.style.paddingLeft&&(width+=parseFloat(element.style.paddingLeft.match(/\d+/),10))),width):width=element.scrollWidth:(styleParser=function(props){var i,prop,total,value,_i,_len;for(value=[],total=0,i=_i=0,_len=props.length;_len>_i;i=++_i)prop=props[i],css[prop]&&(value[i]=parseFloat(css[props[0]].match(/\d+/),10),total+=value[i]);return total},border=styleParser(["border-right-width","border-left-width"]),padding=styleParser(["padding-right","padding-left"]),width=element.scrollWidth+border+padding)},Helper.prototype.getTranslate=function(use3d,x,y,z){return null==use3d&&(use3d=!0),null==y&&(y=0),null==z&&(z=0),this.opts.use3d?"translate3d("+x+"px, 0, 0)":"translate("+x+"px, 0)"},Helper.prototype.getTransitionEndEventName=function(){var browser,match,transitionEndName,ua,version;switch(ua=global.navigator.userAgent.toLowerCase(),match=/(webkit)[ \/]([\w.]+)/.exec(ua)||/(firefox)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||[],browser=match[1],version=parseFloat(match[2],10),"msie"===browser&&version>=10&&(browser="modernIE"),browser){case"webkit":return transitionEndName="webkitTransitionEnd";case"opera":return transitionEndName="oTransitionEnd";case"firefox":case"modernIE":return transitionEndName="transitionend";default:return transitionEndName=void 0}},Helper}(),global.Flickable.Helper=Helper}(this,this.document),function(global,document,helper){var Flickable;return Flickable=function(){function Flickable(element,opts){var _this=this;if(null==opts&&(opts={}),this.el=element,this.opts=opts,this.helper=helper,this.browser=this.helper.checkBrowser(),this.support=this.helper.checkSupport(),this.events=this.helper.checkTouchEvents(),"string"==typeof element)this.el=document.querySelector(element);else if(!this.el)throw Error("Element Not Found");this.opts.use3d=this.opts.disable3d?!1:this.support.transform3d,this.opts.useJsAnimate=!1,this.opts.disableTouch=this.opts.disableTouch||!1,this.opts.disable3d=this.opts.disable3d||!1,this.opts.autoPlay=this.opts.autoPlay||!1,this.opts.interval=this.opts.interval||6600,this.opts.loop=this.opts.loop||(this.opts.autoPlay?!0:!1),this.opts.transition=this.opts.transition||{},this.opts.transition={timingFunction:this.opts.transition.timingFunction||"cubic-bezier(0.23, 1, 0.32, 1)",duration:function(){return _this.opts.transition.duration||(_this.browser.isLegacy?"200ms":"330ms")}()},this.currentPoint=void 0===this.opts.currentPoint&&this.opts.loop?1:this.opts.currentPoint||0,this.maxPoint=this.currentX=this.maxX=0,this.gestureStart=this.moveReady=this.scrolling=this.didCloneNode=!1,this.startTime=this.timerId=this.basePageX=this.startPageX=this.startPageY=this.distance=null,this.support.cssAnimation?this.helper.setStyle(this.el,{transitionProperty:this.helper.getCSSVal("transform"),transitionDuration:"0ms",transitionTimingFunction:this.opts.transition.timingFunction,transform:this._getTranslate(0)}):this.helper.setStyle(this.el,{position:"relative",left:"0px"}),this.support.eventListener&&(document.addEventListener("gesturestart",function(){return _this.gestureStart=!0},!1),document.addEventListener("gestureend",function(){return _this.gestureStart=!1},!1)),global.addEventListener("blur",function(){return _this._clearAutoPlay()},!1),global.addEventListener("focus",function(){return _this._startAutoPlay()},!1),this.el.addEventListener(this.events.start,this,!1),this.opts.autoPlay&&this._startAutoPlay(),this.opts.loop&&this._cloneNode(),this.refresh()}return Flickable.prototype.handleEvent=function(event){switch(event.type){case this.events.start:return this._touchStart(event);case this.events.move:return this._touchMove(event);case this.events.end:return this._touchEnd(event);case"click":return this._click(event)}},Flickable.prototype.refresh=function(){var getMaxPoint,_this=this;return this._setTotalWidth(),getMaxPoint=function(){var childNodes,i,itemLength,node,_i,_len;for(childNodes=_this.el.childNodes,itemLength=0,i=_i=0,_len=childNodes.length;_len>_i;i=++_i)node=childNodes[i],1===node.nodeType&&itemLength++;return itemLength>0&&itemLength--,itemLength},this.maxPoint=void 0===this.opts.maxPoint?getMaxPoint():this.opts.maxPoint,this.distance=void 0===this.opts.distance?this.el.scrollWidth/(this.maxPoint+1):this.opts.distance,this.maxX=-this.distance*this.maxPoint,this.moveToPoint()},Flickable.prototype.hasPrev=function(){return this.currentPoint>0},Flickable.prototype.hasNext=function(){return this.currentPoint<this.maxPoint},Flickable.prototype.toPrev=function(){return this.hasPrev()?this.moveToPoint(this.currentPoint-1):void 0},Flickable.prototype.toNext=function(){return this.hasNext()?this.moveToPoint(this.currentPoint+1):void 0},Flickable.prototype.moveToPoint=function(point,duration){var beforePoint;return null==point&&(point=this.currentPoint),null==duration&&(duration=this.opts.transition.duration),beforePoint=this.currentPoint,this.currentPoint=0>point?0:point>this.maxPoint?this.maxPoint:parseInt(point,10),this.support.cssAnimation?this.helper.setStyle(this.el,{transitionDuration:duration}):this.opts.useJsAnimate=!0,this._setX(-this.currentPoint*this.distance,duration),beforePoint!==this.currentPoint&&(this.helper.triggerEvent(this.el,"flpointmove",!0,!1),this.opts.loop)?this._loop():void 0},Flickable.prototype._setX=function(x,duration){return null==duration&&(duration=this.opts.transition.duration),this.currentX=x,this.support.cssAnimation&&!this.browser.isLegacy?this.helper.setStyle(this.el,{transform:this._getTranslate(x)}):this.opts.useJsAnimate?this._jsAnimate(x,duration):this.el.style.left=""+x+"px"},Flickable.prototype._touchStart=function(event){return this.opts.disableTouch||this.gestureStart?void 0:(this.opts.loop&&(this.currentPoint===this.maxPoint?this.moveToPoint(1,0):0===this.currentPoint&&this.moveToPoint(this.maxPoint-1,0)),this.el.addEventListener(this.events.move,this,!1),document.addEventListener(this.events.end,this,!1),this.events.touch||event.preventDefault(),this.support.cssAnimation?this.helper.setStyle(this.el,{transitionDuration:"0ms"}):this.opts.useJsAnimate=!1,this.scrolling=!0,this.moveReady=!1,this.startPageX=this.helper.getPage(event,"pageX"),this.startPageY=this.helper.getPage(event,"pageY"),this.basePageX=this.startPageX,this.directionX=0,this.startTime=event.timeStamp,this.helper.triggerEvent(this.el,"fltouchstart",!0,!1))},Flickable.prototype._touchMove=function(event){var deltaX,deltaY,distX,isPrevent,newX,pageX,pageY;return this.opts.autoPlay&&this._clearAutoPlay(),this.scrolling&&!this.gestureStart?(pageX=this.helper.getPage(event,"pageX"),pageY=this.helper.getPage(event,"pageY"),this.moveReady?(event.preventDefault(),event.stopPropagation(),distX=pageX-this.basePageX,newX=this.currentX+distX,(newX>=0||this.maxX>newX)&&(newX=Math.round(this.currentX+distX/3)),this.directionX=0===distX?this.directionX:distX>0?-1:1,isPrevent=!this.helper.triggerEvent(this.el,"fltouchmove",!0,!0,{delta:distX,direction:this.directionX}),isPrevent?this._touchAfter({moved:!1,originalPoint:this.currentPoint,newPoint:this.currentPoint,cancelled:!0}):this._setX(newX)):(deltaX=Math.abs(pageX-this.startPageX),deltaY=Math.abs(pageY-this.startPageY),deltaX>5?(event.preventDefault(),event.stopPropagation(),this.moveReady=!0,this.el.addEventListener("click",this,!0)):deltaY>5&&(this.scrolling=!1)),this.basePageX=pageX,this.opts.autoPlay?this._startAutoPlay():void 0):void 0},Flickable.prototype._touchEnd=function(){var newPoint,_this=this;return this.el.removeEventListener(this.events.move,this,!1),document.removeEventListener(this.events.end,this,!1),this.scrolling?(newPoint=function(){var point;return point=-_this.currentX/_this.distance,_this.directionX>0?Math.ceil(point):0>_this.directionX?Math.floor(point):Math.round(point)}(),0>newPoint?newPoint=0:newPoint>this.maxPoint&&(newPoint=this.maxPoint),this._touchAfter({moved:newPoint!==this.currentPoint,originalPoint:this.currentPoint,newPoint:newPoint,cancelled:!1}),this.moveToPoint(newPoint)):void 0},Flickable.prototype._touchAfter=function(params){var _this=this;return this.scrolling=!1,this.moveReady=!1,global.setTimeout(function(){return _this.el.removeEventListener("click",_this,!0)},200),this.helper.triggerEvent(this.el,"fltouchend",!0,!1,params)},Flickable.prototype._click=function(event){return event.stopPropagation(),event.preventDefault()},Flickable.prototype._getTranslate=function(x){return this.opts.use3d?"translate3d("+x+"px, 0, 0)":"translate("+x+"px, 0)"},Flickable.prototype._cloneNode=function(){var childNodes,firstItem,itemAry,lastItem,node,_i,_len;if(childNodes=this.el.childNodes,itemAry=[],this.opts.loop&&!this.didCloneNode){for(_i=0,_len=childNodes.length;_len>_i;_i++)node=childNodes[_i],1===node.nodeType&&itemAry.push(node);return firstItem=itemAry.shift(),lastItem=itemAry.pop(),this.el.insertBefore(lastItem.cloneNode(!0),firstItem),this.el.appendChild(firstItem.cloneNode(!0)),this.didCloneNode=!0}},Flickable.prototype._startAutoPlay=function(){var interval,toNextFn,_this=this;if(this.opts.autoPlay)return toNextFn=function(){return _this.toNext()},interval=this.opts.interval,function(){return _this.timerId=global.setInterval(toNextFn,interval)}()},Flickable.prototype._clearAutoPlay=function(){return global.clearInterval(this.timerId)},Flickable.prototype._setTotalWidth=function(){var childNodes,itemAry,itemWidth,node,totalWidth,_i,_len;for(childNodes=this.el.childNodes,itemAry=0!==childNodes.length?[]:[this.el],_i=0,_len=childNodes.length;_len>_i;_i++)node=childNodes[_i],1===node.nodeType&&itemAry.push(node);return itemWidth=this.helper.getWidth(itemAry[0]),totalWidth=itemWidth*itemAry.length,this.el.style.width=""+totalWidth+"px"},Flickable.prototype._loop=function(){var clearTime,lastPoint,smartLoop,timerId,transitionEndEventName,_this=this;return lastPoint=this.maxPoint-1,clearTime=this.opts.interval/2,smartLoop=function(){return _this.currentPoint===_this.maxPoint?_this.moveToPoint(1,0):0===_this.currentPoint?_this.moveToPoint(lastPoint,0):void 0},transitionEndEventName=this.helper.getTransitionEndEventName(),void 0!==transitionEndEventName?(this.el.addEventListener(transitionEndEventName,smartLoop,!1),global.setTimeout(function(){return _this.el.removeEventListener(transitionEndEventName,smartLoop,!1)},clearTime)):(timerId=smartLoop,global.clearTimeout(function(){return smartLoop()},clearTime))},Flickable.prototype._jsAnimate=function(x,duration){var begin,easing,from,timer,to;return null==duration&&(duration=this.opts.transition.duration),begin=+new Date,from=parseInt(this.el.style.left,10),to=x,duration=parseInt(duration,10),easing=function(time,duration){return-(time/=duration)*(time-2)},timer=global.setInterval(function(){var now,pos,time;return time=new Date-begin,time>duration?(global.clearInterval(timer),now=to):(pos=easing(time,duration),now=pos*(to-from)+from),this.el.style.left=""+now+"px"},10)},Flickable.prototype.destroy=function(){return this.el.removeEventListener(this.events.start,this,!1)},Flickable}(),global.Flickable=Flickable}(this,this.document,new Flickable.Helper);